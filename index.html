<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyShuddle Tracker</title>
</head>
<body>
  <h1>MyShuddle Tracker</h1>
  <button id="startBtn">Start Tracking</button>

  <script>
    const backendUrl = "https://8e37d919c96a.ngrok-free.app/location"; // URL ngrok HTTPS

    document.getElementById("startBtn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by this browser.");
        return;
      }

      // Pedir ubicación inmediatamente desde el click (evento seguro)
      navigator.geolocation.getCurrentPosition(position => {
        alert("Tracking started! ✅");

        // Función para enviar datos al backend
        const sendLocation = (pos) => {
          const locationData = {
            bus_id: "bus123",
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            timestamp: new Date().toISOString()
          };
          fetch(backendUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(locationData)
          })
          .then(res => res.json())
          .then(r => console.log("Server response:", r))
          .catch(err => console.error("Error sending location:", err));
        };

        // Enviar la primera ubicación inmediatamente
        sendLocation(position);

        // Luego iniciar intervalo cada 30s para enviar nuevas ubicaciones
        setInterval(() => {
          navigator.geolocation.getCurrentPosition(sendLocation);
        }, 30000);

      }, error => {
        alert("No se pudo obtener la ubicación: " + error.message);
      });
    });
  </script>
</body>
</html>
